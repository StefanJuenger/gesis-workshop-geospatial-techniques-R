---
title: "Geospatial Techniques for Social Scientists in R"
subtitle: "Advanced Maps I"
author: "Stefan JÃ¼nger & Anne-Kathrin Stroppe<br>February 08, 2021"
output:
  xaringan::moon_reader:
    self_contained: true
    seal: true
    css: ["default", "./assets/css/gesis.css"]
    nature:
      highlightStyle: "github"
      highlightLines: true
      countIncrementalSlides: false
editor_options: 
  chunk_output_type: console
---
layout: true

```{r init-chunk, include = FALSE}
# load all packages
source("../../R/load_packages.R")

opts_chunk$set(echo = TRUE, fig.align = "center", message = FALSE, cache = TRUE)

# load course content table
source("../../R/course_content.R")

options(warn = -1)

xaringanExtra::use_xaringan_extra(c("tile_view", "clipboard"))
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         #<<
  mute_unhighlighted_code = FALSE  #<<
)
```

---

## Check-In 

Short Check-In: How are you feeling in two words? Click [here](XXX).

Any questions remaining from last session you need us to answer?

---

## Workshop Evaluation

Even though, the some more cool stuff is yet to come...

.center[
Please log into [ILIAS](XXXLINKXXX) for the workshop evaluation.
]

---

## What is `ggplot2`?

`ggplot2` is well-known for creating plots.
Thanks to our `sf` working environment, we can exploit all amazing `ggplot2` functions.
Trust us, before `sf` making maps was way more complicated.

In general on `ggplot2`:

- well-suited for multi-dimensional data
- expects data (frames) as input
- components of the plot are added as layers

```{r, eval = F}

plot_call +
  layer_1 +
  layer_2 +
  ... +
  layer_n

```

---

## From `tmap` to `ggplot2`

Reminder: We were fiddling around with `tmap` yesterday and the results were already pretty nice.
`ggplot2` allows us, however, to customize our maps even more, draw on previous knowledge of the package and increase the possibilities to combine maps, plots and more.

The good thing: the inner logic of `tmap` and `ggplot2` is the same and is based on the *grammer of graphics*.


If you are all new to `ggplot`, you might also want to check out:
  - [ggplot2 - Elegant Graphics for Data Analysis](https://www.springer.com/gp/book/9783319242750) by Hadley Wickham
  - [BBC Visual and Data Journalism cookbook for R graphics](https://bbc.github.io/rcookbook/#how_to_create_bbc_style_graphics)
  - [ggplot2 extensions](http://www.ggplot2-exts.org/gallery/)


---

## Components of a plot

According to Wickham ([2010, 8](http://dx.doi.org/10.1198/jcgs.2009.07098)) a layered plot consists of the following components:

- data and aesthetic mappings,
- geometric objects,
- scales,
- and facet specification

```{r plot call example, eval = FALSE, echo = TRUE}

plot_call +
  data +
  aesthetics +
  geometries +
  scales +
  facets

```

---
---

## Let us start building some maps!

First: Get the data!

```{r get-data-display, eval = F}

library(sf)
library(ggplot2)

attributes_districts <-  read.csv("./data/attributes_districts.csv", 
                                  header = T, fill = T, sep = ",") 

german_districts_enhanced <- st_read(dsn = "./data",
                           layer = "GER_DISTRICTS") %>% 
                           rename(., district_id = id) %>% 
                          st_transform(., crs = 3035) %>% 
                          left_join(., attributes_districts, by = "district_id")
                                  
german_states <- st_read(dsn = "./data", layer = "GER_STATES") %>% 
                  st_transform(. , 3035)

```

```{r get-data, echo = F}

german_districts <- st_read(dsn = "../../data",
                           layer = "GER_DISTRICTS",
                           quiet = T) %>% 
                     rename(., district_id = id)

attributes_districts <-  read.csv("../../data/attributes_districts.csv", 
                                  header = T, fill = T, sep = ",") 
                                  
german_districts_enhanced <- 
        german_districts %>% 
        left_join(., attributes_districts, by = "district_id") %>% 
        st_transform(., crs = 3035)
                
german_states <- st_read(dsn = "../../data", layer = "GER_STATES",
                         quiet = T) %>% 
                  st_transform(. , 3035)

```

---

## And I'm Proudly Presenting...

.pull-left[
```{r first-map, eval = FALSE}
# a simple first map 
ggplot() +
 geom_sf(data = german_districts_enhanced)
```
]

--

.pull-right[
```{r firstmap-plot, echo = FALSE}
# a simple first map 
ggplot() +
 geom_sf(data = german_districts_enhanced)
```
]

---

## Making a Plan

This map will be our canvas for the ongoing session.
Obviously, there are hundreds of options to change this maps.
We will cover at least some important building blocks:

  - *THE MAP*: adding attributes, choose from colors and palettes, adding layers
  - *THE LEGEND*: position, sizes, display
  - *THE ENVIRONMENT*: chosing from themes and build your own
  - *THE META-INFORMATION*: titles and sources
  - *THE EXTRAS*: scales and compass

If your working on your own maps the [ggplot2 cheatsheets](https://rstudio.com/wp-content/uploads/2016/11/ggplot2-cheatsheet-2.1.pdf) will help your with questions a perfect overview of scales, themes, labels, facets and more. 

---

## The Map Layer 

.pull-left[
```{r colorfill-map, eval = FALSE}

# easy fill with color
ggplot() +
  geom_sf(data = german_districts_enhanced, 
          fill = "purple", 
          color = "blue")

```
]

.pull-right[
```{r colorfill-plot, echo = FALSE}

# easy fill with color
ggplot() +
  geom_sf(data = german_districts_enhanced, fill = "purple", color = "blue")

```
]

---

## Add the `aesthetics` 

We'll concentrate on mapping the vote share of the German Right-Wing Populist Party (*AfD*) in the German Federal Election in 2017.

.pull-left[
```{r aesthetics, eval = FALSE}

# map aethetics
ggplot() +
  geom_sf(data = german_districts_enhanced, 
          # add the attribute we want to map
          aes(fill = afd_voteshare_2017)) + 
   # choose a continuous palette (optional)
  scale_fill_continuous() 

```
]

--

.pull-right[
```{r aesthetics-plot, echo = FALSE}

# map aethetics
ggplot() +
  geom_sf(data = german_districts_enhanced, aes(fill = afd_voteshare_2017)) + # add the attribute we want to map
  scale_fill_continuous()  # choose a continuous palette fitting your attribute (optional)

```
]

---

## The Map Layer 

.pull-left[
```{r viridis-map, eval = FALSE}

# change color palette
ggplot() +
  geom_sf(data = german_districts_enhanced,
          aes(fill = afd_voteshare_2017)) + 
  # readable with color vision deficiencies
  scale_fill_viridis_c(option = "plasma") 

```
]


.pull-right[
```{r viridis-plot, echo = FALSE}

# change color palette
ggplot() +
  geom_sf(data = german_districts_enhanced,
          aes(fill = afd_voteshare_2017)) + 
  scale_fill_viridis_c(option = "plasma") # readable with color vision deficiencies

```
]

---

## The Map Layer 
 

.pull-left[
```{r direction-map, eval = FALSE}

# change color direction and try without borders
ggplot() +
  geom_sf(data = german_districts_enhanced, 
          aes(fill = afd_voteshare_2017), 
           # make the borders disappear
          color = NA) +
  scale_fill_viridis_c(option = "plasma",
                       # change scale direction
                       direction = -1)  

```
]


.pull-right[
```{r direction-plot, echo = FALSE}

ggplot() +
  geom_sf(data = german_districts_enhanced, 
          aes(fill = afd_voteshare_2017), 
          color = NA) + # make the borders transparent
  scale_fill_viridis_c(option = "plasma", direction = -1)  # change scale direction

```
]

---

## Add another Shapefile 

.pull-left[
```{r 2ndlayer, eval = FALSE}

# realizing that my shapefile includes
# polygons of oceans and lakes
# easy fix onthe fly when you know your data
german_states <-
  german_states %>% 
  filter(., GF == 4 )

# add layer with the boundaries of the German state
ggplot() +
  geom_sf(data = german_districts_enhanced, 
          aes(fill = afd_voteshare_2017), 
          color = NA) + 
  scale_fill_viridis_c(option = "plasma", 
                       direction = -1) +
   # add another layer
  geom_sf(data = german_states,        
          fill = "transparent", 
          color = "white", 
          size = 1) 

```
]


.pull-right[
```{r 2ndlayer-plot, echo = FALSE}

# shoot I got a weird outline I don't want in my shapefile, let's fix it
german_states <-
  german_states %>% 
  filter(., GF == 4 )

# add layer with the boundaries of the German state
ggplot() +
  geom_sf(data = german_districts_enhanced, 
          aes(fill = afd_voteshare_2017), 
          color = NA) + 
  scale_fill_viridis_c(option = "plasma", direction = -1) +
  geom_sf(data = german_states,         # add another layer
          fill = "transparent", 
          color = "white", 
          size = 1) 



```
]

---

## Dealing with the Legend 

.pull-left[
```{r legend, eval = FALSE}

ggplot() +
  geom_sf(data = german_districts_enhanced, 
          aes(fill = afd_voteshare_2017), 
          color = NA) + 
  scale_fill_viridis_c(option = "plasma",
                       direction = -1,
                       # add a legend title
                       name = "AfD Vote Share",
                       # adjust legend
                       guide = guide_legend (
                          # turn it horizontal
                         direction= "horizontal",
                         # put the labels under the legend bar
                         label.position = "bottom")) + 
  geom_sf(data = german_states, 
          fill = "transparent", 
          color = "white") 

```
]


.pull-right[
```{r legend-plot, echo = FALSE}

ggplot() +
  geom_sf(data = german_districts_enhanced, 
          aes(fill = afd_voteshare_2017), 
          color = NA) + 
  scale_fill_viridis_c(option = "plasma", direction = -1,
                       name = "AfD Vote Share", # add a legend title
                       guide = guide_legend (
                         direction= "horizontal", # turn it horizontal
                         label.position = "bottom")) + # put the labels under the legend bar
  geom_sf(data = german_states, 
          fill = "transparent", 
          color = "white") 

```
]

---

## Save and Reuse

Maps produced with `ggplot2` are standard objects like any other object in `R` (they are lists). We can just assign them to re-use, call later, and add map layers.

Furthermore, you can save them just as any `ggplot2` graph.
The `ggsave()` function automatically detects the file format. You can also define the height, width, and dpi, which is particularly useful to produce high-class graphics for publications.

---

# Save and Reuse

```{r eval = FALSE}
afd_map <- 
  ggplot() +
  geom_sf(data = german_districts_enhanced, 
          aes(fill = afd_voteshare_2017), 
          color = NA) + 
  scale_fill_viridis_c(option = "plasma",
                       direction = -1,
                       # add a legend title
                       name = "AfD Vote Share",
                       # adjust legend
                       guide = guide_legend (
                          # turn it horizontal
                         direction= "horizontal",
                         # put the labels under the legend bar
                         label.position = "bottom")) + 
  geom_sf(data = german_states, 
          fill = "transparent", 
          color = "white") 

ggsave("afd_map.png", afd_map, dpi = 300)

```

---

class:middle

## Exercise 2_3_1: Advancced Maps Basis

[Exercise](https://stefanjuenger.github.io/gesis-workshop-geospatial-techniques-R/exercises/2_3_1_Advanced_Maps_Basis_question.html)

[Solution](https://stefanjuenger.github.io/gesis-workshop-geospatial-techniques-R/solutions/2_3_1_Advanced_Maps_Basis_solution.html)

---


## What is there to improve? 

.pull-left[
```{r afdmap, eval = FALSE}

afd_map <- 
  ggplot() +
  geom_sf(data = german_districts_enhanced, 
          aes(fill = afd_voteshare_2017), 
          color = NA) + 
  scale_fill_viridis_c(option = "plasma",
                       direction = -1,
                       # add a legend title
                       name = "AfD Vote Share",
                       # adjust legend
                       guide = guide_legend (
                          # turn it horizontal
                         direction= "horizontal",
                         # put the labels under the legend bar
                         label.position = "bottom")) + 
  geom_sf(data = german_states, 
          fill = "transparent", 
          color = "white")

```
]


.pull-right[
```{r afdmap-plot, echo = FALSE}

afd_map <- 
  ggplot() +
  geom_sf(data = german_districts_enhanced, 
          aes(fill = afd_voteshare_2017), 
          color = NA) + 
  scale_fill_viridis_c(option = "plasma", direction = -1,
                       name = "AfD Vote Share", # add a legend title
                       guide = guide_legend (
                         direction= "horizontal", # turn it horizontal
                         label.position = "bottom")) + # put the labels under the legend bar
  geom_sf(data = german_states, 
          fill = "transparent", 
          color = "white")  

afd_map

```
]

---

## Carrying on: The `theme`

.pull-left[
```{r theme, eval = FALSE}
# use the object afd_map as base layer
afd_map +
  # empty your theme
  theme_void() 

```
]

.pull-right[
```{r theme-plot, echo = FALSE}

ggplot() +
  geom_sf(data = german_districts_enhanced, aes(fill = afd_voteshare_2017), color = NA) + 
  scale_fill_viridis_c(option = "plasma", direction = -1,
                       name = "AfD Vote Share",
                       guide = guide_legend (
                         direction= "horizontal",
                         label.position = "bottom")) +
  geom_sf(data = german_states, fill = "transparent", color = "white") +
  theme_void() # empty your theme

```
]

---

## Build your own `theme` 

.pull-left[
```{r buildtheme-map, eval = FALSE}
# building a theme
afd_map +
  theme_void() + 
  # bold legend text
  theme(title=element_text(face='bold'), 
        # move legend to the bottom of the map
        legend.position = 'bottom', 
         # change background color
        panel.background = element_rect(fill = "lightgrey"))

```
]



.pull-right[
```{r buildtheme-plot, echo = FALSE}

ggplot() +
  geom_sf(data = german_districts_enhanced, aes(fill = afd_voteshare_2017), color = NA) + 
  scale_fill_viridis_c(option = "plasma", direction = -1,
                       name = "AfD Vote Share",
                       guide = guide_legend (
                         direction= "horizontal",
                         label.position = "bottom")) +
  geom_sf(data = german_states, fill = "transparent", color = "white") +
  theme_void() + 
  theme(title=element_text(face='bold'), # bold legend text
        legend.position = 'bottom', # move legend to the bottom of the map
        panel.background = element_rect(fill = "lightgrey")) # change background color


```
]

---

## My (Final?) Result

There is one necessary step to do. You should always make sure to at least include and cite your data sources. Especially in the context of graphs and maps, you can use a short version to directly include in the graph.
This is the complete code:

```{r labs-map, eval = FALSE}

ggplot() +
  geom_sf(data = german_districts_enhanced, 
          aes(fill = afd_voteshare_2017), 
          color = NA) + 
  scale_fill_viridis_c(option = "plasma",
                       direction = -1,
                       name = "AfD Vote Share",
                       guide = guide_legend (
                        direction= "horizontal",
                         label.position = "bottom")) + 
  geom_sf(data = german_states, 
          fill = "transparent", 
          color = "white") +
  theme_void() + 
  theme(title=element_text(face='bold'), 
        legend.position = 'bottom') +
      # add title
  labs(title="Electoral Success AfD",   
       # add sub-title
       subtitle= "German Federal Elections 2017",   
       # add source
       caption=c("Â© Der Bundeswahlleiter, Wiesbaden 2018 & Â© GeoBasis-DE / BKG 2021")) 

```

---

## My (Final?) Result

.small[
.center[
```{r labs-plot, echo = FALSE, out.width="70%"}

afd_map +
  theme_void() + 
  theme(title=element_text(face='bold'), 
        legend.position = 'bottom') +
  labs(title="Electoral Success AfD",                               # add titl
       subtitle= "German Federal Elections 2017",                   # add sub-title
       caption=c("Â© Der Bundeswahlleiter, Wiesbaden 2018 & Â© GeoBasis-DE / BKG 2021")) # add source


```
]
]
---

## To be continued.

Now, you have this super nice map und you start to ask yourself: Is this really the best way to visualize my data? 
.center[
**A map is never finished until you decide to not work on it anymore.**
]

---

## An Example
.pull-left[
```{r try-map, eval = FALSE}

# should i change my map map by using a discrete measure?
german_districts_enhanced$afd_voteshare_quant <-  
  cut(german_districts_enhanced$afd_voteshare_2017,
      breaks = c(0,5,10,13,15,Inf),
      labels=c('< 5','5-10','10-13','13-15','> 15'))

# re-use old code
ggplot() +
  geom_sf(data = german_districts_enhanced,
          # change variable name
          aes(fill = afd_voteshare_quant), 
          color = NA) +   
   # change to the discrete scale
  scale_fill_viridis_d(option = "plasma", 
                       direction = -1,  
                       name = "AfD Vote Share",
                       guide = guide_legend (
                         direction= "horizontal",
                         label.position = "bottom")) +
  geom_sf(data = german_states, fill = "transparent", color = "white") +
  theme_void() + 
  theme(title=element_text(face='bold'), 
        legend.position = 'bottom') +
  labs(title="Electoral Success AfD",                               
       subtitle= "German Federal Elections 2017",                  
       caption=c("Â© Der Bundeswahlleiter, Wiesbaden 2018 Â© GeoBasis-DE / BKG 2021")) 

```
]

--

.pull-right[
```{r try-plot, echo = FALSE}

# should i change my map map by using a discrete measure?
german_districts_enhanced$afd_voteshare_quant <-  
  cut(german_districts_enhanced$afd_voteshare_2017,
      breaks = c(0,5,10,13,15,Inf),
      labels=c('< 5','5-10','10-13','13-15','> 15'))

# re-use old code
ggplot() +
  geom_sf(data = german_districts_enhanced, aes(fill = afd_voteshare_quant), # change variable name
          color = NA) +   
  scale_fill_viridis_d(option = "plasma",  # change to the discrete scale
                       direction = -1,  
                       name = "AfD Vote Share",
                       guide = guide_legend (
                         direction= "horizontal",
                         label.position = "bottom")) +
  geom_sf(data = german_states, fill = "transparent", color = "white") +
  theme_void() + 
  theme(title=element_text(face='bold'), 
        legend.position = 'bottom') +
  labs(title="Electoral Success AfD",                               
       subtitle= "German Federal Elections 2017",                  
       caption=c("Â© Der Bundeswahlleiter, Wiesbaden 2018 & Â© GeoBasis-DE / BKG 2021"))

```
]

---

# Where `ggplot2` cannot help anymore

  
In some specific circumstances, we might realize that `ggplot2` is super powerful but just not designed to build maps.
One example are typical features of maps like a compass or scale bars.

This is where other package might need to be installed.packages
Elements of the package `ggsn` can be included as `ggplot2` layer.
Checkout [Github](http://oswaldosantos.github.io/ggsn/).

---

## The Extras

.pull-left[
```{r add-scale, eval = F}

# add scalebar and north arrow
afd_map +
  ggsn::scalebar(data = german_districts_enhanced, 
                 dist = 100, 
                 dist_unit ="km", 
                 transform = F,
                 location = "bottomright", 
                 st.bottom = T, 
                 st.size = 2.5) +
  ggsn::north(data = german_districts_enhanced, 
              location = "bottomleft")


```
]

.pull-right[
```{r add-scale-plot, echo = FALSE}
afd_map <-
afd_map +
  theme_void() + 
  theme(title=element_text(face='bold'), 
        legend.position = 'bottom') +
  labs(title="Electoral Success AfD",                               # add titl
       subtitle= "German Federal Elections 2017",                   # add sub-title
       caption=c("Â© Der Bundeswahlleiter, Wiesbaden 2018 & Â© GeoBasis-DE / BKG 2021")) + # add source
  ggsn::scalebar(data = german_districts_enhanced, dist = 100, dist_unit ="km", transform = F,
                 location = "bottomright", st.bottom = T, st.size = 2.5) +
  ggsn::north(data = german_districts_enhanced, location = "bottomleft")

afd_map


```
]

---

---

class:middle

## Exercise 2_3_1: Advancced Maps Basis

[Exercise](https://stefanjuenger.github.io/gesis-workshop-geospatial-techniques-R/exercises/2_3_2_Advanced_Maps_Basis_question.html)

[Solution](https://stefanjuenger.github.io/gesis-workshop-geospatial-techniques-R/solutions/2_3_1_Advanced_Maps_Basis_solution.html)

.center[**Create your Best Map!**]

---

class: middle
## The Map-Off

---

## Add a Raster Layer

```{r, eval = F}
stars::geom_stars(data = stars::st_as_stars(raster_file))
```

---


## Customize the Customized Maps

You can also annotate plots with titles, subtitles, captions, and tags. 

You can nest plots and introduce more complex layouts.

Tip: If you're interested you can check out the [`patchwork` repository on *GitHub*](https://github.com/thomasp85/patchwork) since everything is really well-documented there.


---

## The Art of Mapping

There are quite a few examples how far we can get when mastering the art of mapping with `ggplot2`.
One of my favourite maps was designed by [Timo Grossenbacher](https://timogrossenbacher.ch/2019/04/bivariate-maps-with-ggplot2-and-sf/).

.center[
```{r swiss-map, echo = FALSE, out.width = "80%"}
knitr::include_graphics("./img/grossenbacher_switzerland.png")
```
]


---

## More inspiration

.pull-left[
```{r stree-map, echo = FALSE, out.width = "90%"}
knitr::include_graphics("./img/city_maps.png")
```
]

.pull-right[
You can find inspiration all over the web:

- Super nice tutorial to actual design artworks like these by [gplot2tutor]( https://ggplot2tutor.com/streetmaps/streetmaps/)
- Get Inspired by our GIS friends working on the [ArcGIS Blog]( https://www.esri.com/arcgis-blog/overview/)
- Check Out [R Graph Gallery](https://www.r-graph-gallery.com/) for Hexbins and Bubble Maps.
- And keep an eye out for the #30DayMapChallenge on Twitter and check last years' [Github repository](https://github.com/tjukanovt/30DayMapChallenge)

]
 

---

## .. and don't forget


**Try and error goes a long way**.
If your frustration is especially high, you might want to find some comfort in [this Twitter account](https://twitter.com/accidental__art?lang=en) account which collects `ggplot2` graphs which turned into art instead of a useful visualization.




---

layout: false
class: center
background-image: url(./img/the_end.png)
background-size: cover

.left-column[
</br>
```{r pic-me, echo = FALSE, out.width = "90%"}
knitr::include_graphics("./img/anne.png")
```
]

.right-column[
.left[.small[`r icon::fontawesome("envelope")` [`anne-kathrin.stroppe@gesis.org`](mailto:anne-kathrin.stroppe@gesis.org)] </br>
.small[`r icon::fontawesome("twitter")` [`@AStroppe`](https://twitter.com/AStroppe)] </br>
.small[`r icon::fontawesome("github")` [`Stroppan`](https://github.com/stroppan)] </br>
]
]